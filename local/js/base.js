// Generated by CoffeeScript 1.6.3
(function() {
  var __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  window.Drawable = (function(_super) {
    __extends(Drawable, _super);

    function Drawable(x, y, width, height) {
      Drawable.__super__.constructor.call(this);
      this.x = x || 0;
      this.y = y || 0;
      this.imgData = null;
      this.width = width || 30;
      this.height = height || 30;
      this.anchorX = parseInt(this.width / 2);
      this.anchorY = parseInt(this.height / 2);
      this.onshow = true;
      this.transform = {
        opacity: null,
        scaleX: null,
        scaleY: null,
        rotate: null,
        martrix: null
      };
      this.drawQueue = {
        before: [],
        after: []
      };
    }

    Drawable.prototype.onDraw = function(context, tickDelay) {
      var item, _i, _j, _len, _len1, _ref, _ref1;
      context.save();
      this.handleTransform(context);
      _ref = this.drawQueue.before;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        item = _ref[_i];
        item.onDraw(context, tickDelay);
      }
      if (this.draw) {
        this.draw(context);
      }
      _ref1 = this.drawQueue.after;
      for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
        item = _ref1[_j];
        item.onDraw(context, tickDelay);
      }
      return context.restore();
    };

    Drawable.prototype.handleTransform = function(context) {
      var t;
      t = this.transform;
      context.translate(parseInt(this.x, parseInt(this.y)));
      if (t.opacity) {
        context.globalAlpha = t.opacity;
      }
      if (t.scaleX || t.scaleY) {
        context.scale(t.scaleX || 1, t.scaleY || 1);
      }
      if (t.rotate) {
        return context.rotate(t.rotate);
      }
    };

    Drawable.prototype.setImg = function(img, resX, resY, resWidth, resHeight) {
      return this.imgData = {
        img: img,
        x: resX,
        y: resY,
        width: resWidth,
        height: resHeight
      };
    };

    Drawable.prototype.draw = function(context) {
      var i, s, x, y;
      if (!this.onshow) {
        return;
      }
      s = Utils.getSize();
      x = this.x - this.anchorX;
      y = this.y - this.anchorY;
      if (x >= s.width || y >= s.height) {
        return;
      }
      if (this.imgData) {
        i = this.imgData;
        if (i.x) {
          return context.drawImage(i.img, i.x, i.y, i.width, i.height, x, y, this.width, this.height);
        } else {
          return context.drawImage(i.img, x, y, this.width, this.height);
        }
      } else if (GameConfig.debug === 2) {
        context.fillStyle = "rgba(20,20,20,0.2)";
        return context.fillRect(x, y, this.width, this.height);
      }
    };

    Drawable.prototype.clearDrawQueue = function() {
      this.drawBefore = [];
      return this.drawAfter = [];
    };

    Drawable.prototype.drawQueueRemove = function(drawable) {
      if (Utils.removeItem(drawable, this.drawQueue.after)) {
        return;
      }
      return Utils.removeItem(drawable, this.drawQueue.before);
    };

    Drawable.prototype.drawQueueAddAfter = function() {
      var d, _i, _len, _results;
      _results = [];
      for (_i = 0, _len = arguments.length; _i < _len; _i++) {
        d = arguments[_i];
        if (!d.onDraw) {
          console.error("" + d + " is not drawable");
        }
        _results.push(this.drawQueue.after.push(d));
      }
      return _results;
    };

    Drawable.prototype.drawQueueAddBefore = function() {
      var d, _i, _len, _results;
      _results = [];
      for (_i = 0, _len = arguments.length; _i < _len; _i++) {
        d = arguments[_i];
        if (!d.onDraw) {
          console.error("" + d + " is not drawable");
        }
        _results.push(this.drawQueue.before.push(d));
      }
      return _results;
    };

    return Drawable;

  })(Suzaku.EventEmitter);

  window.Animateble = (function(_super) {
    __extends(Animateble, _super);

    function Animateble(x, y, width, height) {
      Animateble.__super__.constructor.call(this, x, y, width, height);
      this._animates = [];
    }

    Animateble.prototype.onDraw = function(context, tickDelay) {
      this._handleAnimate(tickDelay);
      return Animateble.__super__.onDraw.call(this, context, tickDelay);
    };

    Animateble.prototype._handleAnimate = function(tickDelay) {
      var a, arr, item, p, _i, _j, _k, _len, _len1, _len2, _ref, _ref1, _ref2;
      _ref = this._animates;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        a = _ref[_i];
        a.sumDelay += tickDelay;
        p = a.easing(a.time, a.sumDelay);
        if (p > 0.99) {
          p = 1;
          a.end = true;
        }
        a.func.call(this, p);
      }
      arr = [];
      _ref1 = this._animates;
      for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
        a = _ref1[_j];
        if (a.end) {
          if (a.callback) {
            a.callback();
          }
        } else {
          arr.push(a);
        }
      }
      _ref2 = this._animates;
      for (_k = 0, _len2 = _ref2.length; _k < _len2; _k++) {
        item = _ref2[_k];
        item = null;
      }
      return this._animates = arr;
    };

    Animateble.prototype.fadeIn = function(time, callback) {
      return this.animate((function(p) {
        return this.transform.opacity = p;
      }), time, "linear", callback);
    };

    Animateble.prototype.fadeOut = function(time, callback) {
      return this.animate((function(p) {
        return this.transform.opacity = 1 - p;
      }), time, "linear", callback);
    };

    Animateble.prototype.animate = function(func, time, easing, callback) {
      var obj;
      if (time == null) {
        time = "normal";
      }
      if (easing == null) {
        easing = "swing";
      }
      if (!func) {
        return console.error("no func");
      }
      if (typeof func === "object") {
        obj = func;
        func = this._generateAnimateFunc(obj);
      }
      if (typeof time === "string") {
        switch (time) {
          case "fast":
            time = 200;
            break;
          case "normal":
            time = 350;
            break;
          case "slow":
            time = 600;
        }
      }
      if (typeof easing === "string") {
        switch (easing) {
          case "swing":
            easing = Animateble.swing;
            break;
          default:
            easing = Animateble.linear;
        }
      }
      return this._animates.push({
        func: func,
        time: time,
        easing: easing,
        end: false,
        callback: callback,
        sumDelay: 0
      });
    };

    Animateble.prototype._generateAnimateFunc = function(obj) {
      var arr, dataObj, f, n, name, ref, targetValue, _i, _len;
      dataObj = {};
      for (name in obj) {
        targetValue = obj[name];
        if (isNaN(targetValue)) {
          if (GameConfig.debug) {
            console.error("invailid value:" + targetValue);
          }
        }
        arr = name.split(".");
        ref = this;
        for (_i = 0, _len = arr.length; _i < _len; _i++) {
          n = arr[_i];
          ref = ref[n];
        }
        if (isNaN(ref)) {
          if (GameConfig.debug) {
            console.error("invailid key:" + name + "," + n);
          }
        }
        dataObj[name] = {
          origin: ref,
          delta: targetValue - ref
        };
      }
      f = function(p) {
        var data, delta, index, _j, _len1, _results;
        _results = [];
        for (name in dataObj) {
          delta = dataObj[name];
          arr = name.split(".");
          ref = this;
          for (index = _j = 0, _len1 = arr.length; _j < _len1; index = ++_j) {
            n = arr[index];
            if (index < (arr.length - 1)) {
              ref = ref[n];
            }
          }
          n = arr.pop();
          data = dataObj[name];
          _results.push(ref[n] = data.origin + data.delta * p);
        }
        return _results;
      };
      return f;
    };

    return Animateble;

  })(Drawable);

  Animateble.swing = function(time, sumDelay) {
    var p;
    return p = sumDelay / time;
  };

  Animateble.linear = function(time, sumDelay, tickDelay) {
    var p;
    p = sumDelay / time;
    return -Math.cos(p * Math.PI) / 2 + 0.5;
  };

  window.Camera = (function(_super) {
    __extends(Camera, _super);

    function Camera(x, y) {
      var size;
      size = Utils.getSize();
      x = x || size.width / 2;
      y = y || size.height / 2;
      Camera.__super__.constructor.call(this, x, y, size.width, size.height);
      this.scale = 0;
      this.defaultX = this.x;
      this.defaultY = this.y;
      this.lens = this.defaultLens = 1;
    }

    Camera.prototype.lookAt = function(target, time) {
      this.moveTo(target.x, target.y, time);
      return this.lensTo(this.width / target.width * 1.1, time);
    };

    Camera.prototype.lensTo = function(l, time) {
      var dl,
        _this = this;
      dl = l - this.lens;
      return this.animate((function(p) {
        return _this.lens = dl * p;
      }), time, "swing");
    };

    Camera.prototype.moveTo = function(x, y, time) {
      var dx, dy,
        _this = this;
      dx = x - this.x;
      dy = y - this.y;
      return this.animate((function(p) {
        _this.x = dx * p;
        return _this.y = dy * p;
      }), time, "swing");
    };

    Camera.prototype.reset = function() {
      this.x = this.defaultX;
      this.y = this.defaultY;
      return this.lens = this.defaultLens;
    };

    return Camera;

  })(Animateble);

  window.Layer = (function(_super) {
    __extends(Layer, _super);

    function Layer(x, y, width, height) {
      var s;
      s = Utils.getSize();
      Layer.__super__.constructor.call(this, 0, 0, s.width, s.height);
      this.anchorX = 0;
      this.anchorY = 0;
      this.z = 0;
      this.camera = null;
    }

    Layer.prototype.setCamera = function(c) {
      return this.camera = c;
    };

    Layer.prototype.renderWithCamera = function(context) {
      return context.translate(parseInt(-this.camera.x, parseInt(-this.camera.y)));
    };

    Layer.prototype.onDraw = function(context, tickDelay) {
      var item, _i, _j, _len, _len1, _ref, _ref1;
      this._handleAnimate(tickDelay);
      context.save();
      this.handleTransform(context);
      if (this.camera) {
        this.renderWithCamera();
      }
      _ref = this.drawQueue.before;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        item = _ref[_i];
        item.onDraw(context);
      }
      if (this.draw) {
        this.draw(context);
      }
      _ref1 = this.drawQueue.after;
      for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
        item = _ref1[_j];
        item.onDraw(context);
      }
      return context.restore();
    };

    Layer.prototype.renderWithCamera = function(context) {
      return context.translate(parseInt(-this.camera.x, parseInt(-this.camera.y)));
    };

    return Layer;

  })(Animateble);

  window.Menu = (function(_super) {
    __extends(Menu, _super);

    function Menu(tpl) {
      Menu.__super__.constructor.call(this, tpl);
      this.J = $("#UILayer");
    }

    Menu.prototype.init = function() {
      this.J.hide();
      this.J.html("");
      return this.appendTo(this.J);
    };

    Menu.prototype.show = function() {
      this.init();
      return this.J.fadeIn("fast");
    };

    Menu.prototype.hide = function() {
      return this.J.fadeOut("fast");
    };

    return Menu;

  })(Suzaku.Widget);

  window.Stage = (function(_super) {
    __extends(Stage, _super);

    function Stage(game) {
      this.game = game;
      Stage.__super__.constructor.call(this);
      this.anchorX = 0;
      this.anchorY = 0;
    }

    Stage.prototype.show = function(callback) {
      return this.fadeIn("fast", callback);
    };

    Stage.prototype.hide = function(callback) {
      return this.fadeOut("fast", callback);
    };

    Stage.prototype.tick = function() {};

    return Stage;

  })(Animateble);

}).call(this);
